<!doctype HTML>
<html>
<head>
<title>Electromagnetic Field Simulation</title>
<script type="text/javascript">
var can0,ctx0,can1,ctx1,selector;
var charge1;
var Ex,Ey,Ez,Bx,By,Bz;
var conditions=[];
var mousedown=false;
var tmax, stepsize;
var presetarray=[];

function sin(a){return Math.sin(a)}
function cos(a){return Math.cos(a)}
function tan(a){return Math.tan(a)}
function ln(a){return Math.log(a)}
function pow(a,b){return Math.pow(a,b)}
function exp(a){return Math.exp(a)}
function sqrt(a){return Math.sqrt(a)}
function asin(a){return Math.asin(a)}
function acos(a){return Math.acos(a)}
function atan(a){return Math.atan(a)}
function abs(a){return Math.abs(a)}
var pi=Math.PI;
var e=Math.E;
function dist(x,y,z,a,b,c){
return Math.sqrt((x-a)*(x-a)+(y-b)*(y-b)+(z-c)*(z-c));
}

function Preset(name,description,field,param,con){
	this.name=name;
	this.description=description;
	this.field=field;
	this.param=param;
	this.con=con;
	this.updatepreset=function(){
		document.getElementById("desc").innerHTML=this.description;
		document.getElementById("ex").value=this.field[0];
		document.getElementById("ey").value=this.field[1];
		document.getElementById("ez").value=this.field[2];
		document.getElementById("bx").value=this.field[3];
		document.getElementById("by").value=this.field[4];
		document.getElementById("bz").value=this.field[5];
		
		document.getElementById("tmax").value=this.param[0];
		document.getElementById("stepsize").value=this.param[1];
		
		document.getElementById("charge").value=this.con[0];
		document.getElementById("px").value=this.con[1];
		document.getElementById("py").value=this.con[2];
		document.getElementById("pz").value=this.con[3];	
		document.getElementById("vx").value=this.con[4];
		document.getElementById("vy").value=this.con[5];
		document.getElementById("vz").value=this.con[6];
	}
}

function Charge(con){
	this.q=con[0];
	this.x=con[1];
	this.y=con[2];
	this.z=con[3];
	this.vx=con[4];
	this.vy=con[5];
	this.vz=con[6];
	
	var Bvec;
	this.ax=function(x,y,z,vy,vz){
		return this.q*(Ex(x,y,z)+vy*Bvec[2]-vz*Bvec[1])
	}
	this.ay=function(x,y,z,vz,vx){
		return this.q*(Ey(x,y,z)+vz*Bvec[0]-vx*Bvec[2])
	}
	this.az=function(x,y,z,vx,vy){
		return this.q*(Ez(x,y,z)+vx*Bvec[1]-vy*Bvec[0]);
	}
	
	this.step=function(dt){
		ctx0.beginPath();
		ctx0.moveTo(this.x,can0.height-this.y);
		Bvec=[Bx(this.x,this.y,this.z),By(this.x,this.y,this.z),Bz(this.x,this.y,this.z)];
		
		var kx1=dt*this.vx;
		var kvx1=dt*this.ax(this.x,this.y,this.z,this.vy,this.vz);
		var ky1=dt*this.vy;
		var kvy1=dt*this.ay(this.x,this.y,this.z,this.vz,this.vx);
		var kz1=dt*this.vz;
		var kvz1=dt*this.az(this.x,this.y,this.z,this.vx,this.vy);
		
		var kx2=dt*(this.vx+kvx1/2);
		var kvx2=dt*this.ax(this.x+kx1/2,this.y+ky1/2,this.z+kz1/2,this.vy+kvy1/2,this.vz+kvz1/2);
		var ky2=dt*(this.vy+kvy1/2);
		var kvy2=dt*this.ay(this.x+kx1/2,this.y+ky1/2,this.z+kz1/2,this.vz+kvz1/2,this.vx+kvx1/2);
		var kz2=dt*(this.vz+kvz1/2);
		var kvz2=dt*this.az(this.x+kx1/2,this.y+ky1/2,this.z+kz1/2,this.vx+kvx1/2,this.vy+kvy1/2);
		
		var kx3=dt*(this.vx+kvx2/2);
		var kvx3=dt*this.ax(this.x+kx2/2,this.y+ky2/2,this.z+kz2/2,this.vy+kvy2/2,this.vz+kvz2/2);
		var ky3=dt*(this.vy+kvy2/2);
		var kvy3=dt*this.ay(this.x+kx2/2,this.y+ky2/2,this.z+kz2/2,this.vz+kvz2/2,this.vx+kvx2/2);
		var kz3=dt*(this.vz+kvz2/2);
		var kvz3=dt*this.az(this.x+kx2/2,this.y+ky2/2,this.z+kz2/2,this.vx+kvx2/2,this.vy+kvy2/2);
		
		var kx4=dt*(this.vx+kvx3);
		var kvx4=dt*this.ax(this.x+kx3,this.y+ky3,this.z+kz3,this.vy+kvy3,this.vz+kvz3);
		var ky4=dt*(this.vy+kvy3);
		var kvy4=dt*this.ay(this.x+kx3,this.y+ky3,this.z+kz3,this.vz+kvz3,this.vx+kvx3);
		var kz4=dt*(this.vz+kvz3);
		var kvz4=dt*this.az(this.x+kx3,this.y+ky3,this.z+kz3,this.vx+kvx3,this.vy+kvy3);
		
		this.x+=(kx1+2*kx2+2*kx3+kx4)/6;
		this.vx+=(kvx1+2*kvx2+2*kvx3+kvx4)/6;
		this.y+=(ky1+2*ky2+2*ky3+ky4)/6;
		this.vy+=(kvy1+2*kvy2+2*kvy3+kvy4)/6;
		this.z+=(kz1+2*kz2+2*kz3+kz4)/6;
		this.vz+=(kvz1+2*kvz2+2*kvz3+kvz4)/6;
		//there's probably a better way to do this
		
		ctx0.lineTo(this.x,can0.height-this.y);
		ctx0.stroke();
	}
}
function draw(){
//var s=new Date().getTime();
var i;
	for(i=0;i<Math.floor(tmax/stepsize);i++){//no floats allowed
		charge1.step(stepsize);
	}
	charge1.step(tmax%stepsize);
	//console.log(checkerror(charge1.vx*charge1.vx+charge1.vy*charge1.vy,conditions[4]*conditions[4]+conditions[5]*conditions[5]));
//console.log((new Date().getTime()-s));
}
function changepreset(){
presetarray[selector.selectedIndex].updatepreset();
ctx0.clearRect(0,0,900,600);
launch();
}
function init(){
	can0=document.getElementById("can0");
	ctx0=can0.getContext("2d");
	can1=document.getElementById("can1");
	ctx1=can1.getContext("2d");
	can1.addEventListener("mousedown",setpos);
	can1.addEventListener("mouseup",setvel);
	can1.addEventListener("mousemove",showinput);
	selector=document.getElementById("selector");
	ctx0.strokeStyle="#fff";
	ctx1.strokeStyle="#aae";
	update();
	
	presetarray[1]=new Preset("Uniform B",
	"Uniform magnetic field pointing out of the screen.",
	["0","0","0","0","0","1"],
	["10","0.01"],
	["-1","400","100","0","200","0","0"]);
	
	presetarray[2]=new Preset("Circular B",
	"Magnetic field generated by a current from an infinite wire through point (450,300).",
	["0","0","0","(300-y)/dist(450,300,0,x,y,0)","(x-450)/dist(450,300,0,x,y,0)","0"],
	["100","0.01"],
	["-1","400","100","0","200","0","0"]);
	
	presetarray[3]=new Preset("Electric point charge",
	"Electric field generated by a positive point charge.",
	["(x-450)/pow(dist(450,300,0,x,y,z),3)","(y-300)/pow(dist(450,300,0,x,y,0),3)","0","0","0","0"],
	["100","0.01"],
	["-100000","400","100","0","200","0","0"]);
	
	presetarray[4]=new Preset("Velocity selector",
	"Vertical E field and out-of-screen B field in the region 300 < x < 400. An electron "+
	"launched horizontally through the region will experience an electric force downwards "+
	"and a magnetic force proportional to velocity upwards. If the velocity is equal to "+
	"E/B (In this case 100), the two forces cancel each other out and there is no deflection.",
	["0","(x<300||x>400)? 0 : 100","0","0","0","(x<300||x>400)? 0 : 1"],
	["10","0.01"],
	["-1","250","300","0","100","0","0"]);
	presetarray[]=new Preset("Magnetic bottle",
	"Two infinitesimally small magnetic dipoles at (200,300) and (700,300) that trap an electron between them.",
	["0","0","0",
	 "(3*(x-200)*(x-200)-(y-300)*(y-300)-z*z)/pow(dist(x,y,z,200,300,0),5)+(3*(x-700)*(x-700)-(y-300)*(y-300)-z*z)/pow(dist(x,y,z,700,300,0),5)",
	 "3*(x-200)*(y-300)/pow(dist(x,y,z,200,300,0),5)+3*(x-700)*(y-300)/pow(dist(x,y,z,700,300,0),5)",
	 "3*(x-200)*(z)/pow(dist(x,y,z,200,300,0),5)+3*(x-700)*(z)/pow(dist(x,y,z,700,300,0),5)"],
	["50","0.005"].
	["-5000000","420","350","0","40","-10","0"]);
	
}
function update(){
	Ex=new Function("x","y","z", "return " + document.getElementById("ex").value);
	Ey=new Function("x","y","z", "return " + document.getElementById("ey").value);
	Ez=new Function("x","y","z", "return " + document.getElementById("ez").value);
	Bx=new Function("x","y","z", "return " + document.getElementById("bx").value);
	By=new Function("x","y","z", "return " + document.getElementById("by").value);
	Bz=new Function("x","y","z", "return " + document.getElementById("bz").value);
	tmax=parseFloat(document.getElementById("tmax").value);
	stepsize=parseFloat(document.getElementById("stepsize").value);
	
	conditions[0]=parseFloat(document.getElementById("charge").value);
	conditions[1]=parseFloat(document.getElementById("px").value);
	conditions[2]=parseFloat(document.getElementById("py").value);
	conditions[3]=parseFloat(document.getElementById("pz").value);
	conditions[4]=parseFloat(document.getElementById("vx").value)
	conditions[5]=parseFloat(document.getElementById("vy").value)
	conditions[6]=parseFloat(document.getElementById("vz").value)
}

function setpos(e){
	document.getElementById("px").value=e.clientX-can0.offsetLeft;
	document.getElementById("py").value=can0.height+can0.offsetTop-e.clientY;
	document.getElementById("pz").value=0;
	mousedown=true;
}
function setvel(e){
if(mousedown){
	document.getElementById("vx").value=e.clientX-can0.offsetLeft-document.getElementById("px").value;
	document.getElementById("vy").value=can0.height+can0.offsetTop-e.clientY-document.getElementById("py").value;
	document.getElementById("vz").value=0;
	launch();
}
mousedown=false;

}
function launch(){
update();
charge1=new Charge(conditions);
draw();
}
function showinput(e){
	ctx1.clearRect(0,0,900,600);
	document.getElementById("xdisplay").innerHTML=(e.clientX-can0.offsetLeft);
	document.getElementById("ydisplay").innerHTML=(can0.height+can0.offsetTop-e.clientY);
	if(mousedown){
		document.getElementById("vx").value=e.clientX-can0.offsetLeft-document.getElementById("px").value;
		document.getElementById("vy").value=can0.height+can0.offsetTop-e.clientY-document.getElementById("py").value;
		document.getElementById("vz").value=0;
		
		ctx1.beginPath();
		ctx1.moveTo(document.getElementById("px").value,can0.height-document.getElementById("py").value);
		ctx1.lineTo(e.clientX-can0.offsetLeft,e.clientY-can0.offsetTop);
		ctx1.stroke();
	}
}
function Ecolor(sc){
	for(var j=0;j<can0.height;j+=5){
	for(var i=0;i<can0.width;i+=5){
		
		ctx1.beginPath();
		ctx1.moveTo(i,j);
		ctx1.lineTo(i+Ex(i,j,0),j+Ey(i,j,0));
		ctx1.stroke();
		}
	}
}
function rk4(a,b){
	vn=0;
	xn=10;
	function x2p(x,dx){
		return(-x);
	}
	for(var i=0;i<a;i+=b){
	ctx1.beginPath();
	ctx1.moveTo(i*10,300-10*xn);
		
	k1=b*x2p(xn,vn);
	l1=b*vn;
	
	k2=b*x2p(xn+l1/2,vn+k1/2);
	l2=b*(vn+k1/2);
	
	k3=b*x2p(xn+l2/2,vn+k2/2);
	l3=b*(vn+k2/2);
	
	k4=b*x2p(xn+l3,vn+k3);
	l4=b*(vn+k3);
	
	vn+=(k1+2*k2+2*k3+k4)/6;
	xn+=(l1+2*l2+2*l3+l4)/6;
	
	ctx1.lineTo(10*(i+b),300-10*xn);

	ctx1.stroke();
}

return xn;
}

function checkerror(quan,known){
	var est=quan;
	return(est-known);
}

</script>
<style>
*{
font-size:12pt;
color:#fff;
}
body{
font-family:menlo,"Lucida Console",sans-serif;
}
input{
background-color:#555;
border:1px solid #444;
}
button{
background-color:#2c0;
}
#sidebar{
position:absolute;
left:916px;
top:8px;
padding:4px;
background-color:#215;
border-radius:2px;
}
#can0{
position:absolute;
background-color:#000;
z-index:0;
}
#can1{
z-index:1;
position:relative;
}
#clear{
background-color:#c00;
}
.coords{
padding:4px;
background-color:black;
color:#0ff;
width:9.5em;
}
#xdisplay,#ydisplay{
text-align:right;
float:right;
color:#0ff;
}
#desc{
font-family: calibri, sans-serif;
width:900px;
}
option{
color:#000;
}
</style>
</head>
<body bgcolor="#333" onload="init()">
<div class="fields">
<b>E</b>=<input type="text" id="ex" size="24" value="0"> i&#770; + 
<input type="text" id="ey" size="24" value="0"> j&#770; + 
<input type="text" id="ez" size="24" value="0"> k&#770;
<br>
<b>B</b>=<input type="text" id="bx" size="24" value="0"> i&#770; + 
<input type="text" id="by" size="24" value="0"> j&#770; + 
<input type="text" id="bz" size="24" value="(x<200)? 0 : 1"> k&#770;<br>
</div>
<canvas width="900" height="600" id="can0"></canvas>
<canvas width="900" height="600" id="can1"></canvas>
<div id="sidebar">
<button onclick="launch()">Launch Particle</button><br>
max t <input type="text" id="tmax" size="6" value="10"><br>
&#916;t <input type="text" id="stepsize" size="6" value="0.01"><br>
q/m <input type="text" id="charge" size="6" value="-1"><br>
<div class="coords">
Mouse position:<br>
x<span id="xdisplay"></span><br>
y<span id="ydisplay"></span>
</div>
<b>Initial Conditions</b>
<div>Position:</div>
x:<input type="text" id="px" size="6" value=""><br>
y:<input type="text" id="py" size="6" value=""><br>
z:<input type="text" id="pz" size="6" value="">
<div>Velocity:</div>
x:<input type="text" id="vx" size="6" value=""><br>
y:<input type="text" id="vy" size="6" value=""><br>
z:<input type="text" id="vz" size="6" value=""><br>

<button id="clear" onclick="ctx0.clearRect(0,0,900,600)">Clear Screen</button>
<br>
<br>
<b>Presets</b>
<br>
<select id="selector" onchange="changepreset()">
<option>None</option>
<option>Uniform B</option>
<option>Circular B</option>
<option>Electric point charge</option>
<option>Velocity selector</option>
</select>

</div>
<div id="desc"></div>
</body>
</html>
